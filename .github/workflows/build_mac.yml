name: Build Mac App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 1. Install Python libs and PyInstaller
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sounddevice faster-whisper numpy pyinstaller

      # 2. Compile Python bridge to single executable
      #    If whisper_mic_bridge.py is not in repo root, change the path here.
      - name: Build Python executable
        run: |
          pyinstaller --onefile --name whisper_bridge --clean whisper_mic_bridge.py

      # 3. Publish .NET app for macOS
      #    Make sure the csproj path and app name (InterviewCopilot) match your project.
      - name: Publish .NET app
        run: |
          dotnet publish Source/Source.csproj \
            -c Release \
            -r osx-x64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o publish

      # 4. Create .app bundle
      - name: Create Mac bundle
        run: |
          mkdir -p "InterviewCopilot.app/Contents/MacOS"
          mkdir -p "InterviewCopilot.app/Contents/Resources"

          # Copy published .NET files
          cp publish/InterviewCopilot "InterviewCopilot.app/Contents/MacOS/" || true
          cp publish/*.dll "InterviewCopilot.app/Contents/MacOS/" || true
          cp publish/*.dylib "InterviewCopilot.app/Contents/MacOS/" 2>/dev/null || true
          cp publish/*.json "InterviewCopilot.app/Contents/MacOS/" || true

          # Copy compiled Python bridge
          # If dist is under a subfolder, adjust to e.g. Source/dist/whisper_bridge
          cp dist/whisper_bridge "InterviewCopilot.app/Contents/MacOS/" || true

          # Create Info.plist (note: EOF is at start of line)
          cat > "InterviewCopilot.app/Contents/Info.plist" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>CFBundleExecutable</key>
    <string>InterviewCopilot</string>
    <key>CFBundleIdentifier</key>
    <string>com.yourname.interviewcopilot</string>
    <key>CFBundleName</key>
    <string>InterviewCopilot</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>NSMicrophoneUsageDescription</key>
    <string>Need microphone for transcription</string>
    <key>NSHighResolutionCapable</key>
    <true/>
  </dict>
</plist>
EOF

      # 5. Zip and upload
      - name: Zip app
        run: zip -r "InterviewCopilot_Mac.zip" "InterviewCopilot.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MacApp
          path: InterviewCopilot_Mac.zip
